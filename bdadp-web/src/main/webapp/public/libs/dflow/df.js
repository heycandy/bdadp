var DFlow=function(G,X){this.myDiagram=G;this.dragged=X;var Z=this;var H,W;var Q=[];var V={mode:"flow",itemType:"flow",nodeCounter:{stock:0,cloud:0,variable:0,valve:0}};var M=function(f){var h=0,g=f.length,e=-1;for(var d=0;d<g;d++){e=f.charCodeAt(d);if(e>=0&&e<=128){h+=1}else{h+=2}}return h};function L(f,g){var h=0;var e=0;str_cut=new String();e=f.length;for(var d=0;d<e;d++){a=f.charAt(d);h++;if(escape(a).length>4){h++}str_cut=str_cut.concat(a);if(h>=g){str_cut=str_cut.concat(".");return str_cut}}if(h<g){return f}}var Y=function(i,h,p,o,f,m,g,d,l){var e=go.GraphObject.make;G=e(go.Diagram,i,{initialAutoScale:go.Diagram.UniformToFill,initialContentAlignment:go.Spot.Center,scrollMode:go.Diagram.InfiniteScroll,"toolManager.hoverDelay":1000,padding:0,allowDrop:true,"LinkDrawn":P,"LinkRelinked":P,"animationManager.duration":80,"linkingTool.doActivate":function(){this.temporaryLink.curve=(V.itemType==="flow")?go.Link.Normal:go.Link.Bezier;this.temporaryLink.path.stroke=(V.itemType==="flow")?"gray":"green";this.temporaryLink.path.strokeWidth=(V.itemType==="flow")?1:1;go.LinkingTool.prototype.doActivate.call(this)},"linkingTool.insertLink":function(t,s,r,q){return go.LinkingTool.prototype.insertLink.call(this,t,s,r,q)},"linkingTool.isEnabled":true,"linkingTool.direction":go.LinkingTool.ForwardsOnly,"undoManager.isEnabled":true,"ChangedSelection":o,});var k=null;if(h){k=e(go.Overview,h,{observed:G,contentAlignment:go.Spot.Center})}G.grid=e(go.Panel,go.Panel.Grid,{gridCellSize:new go.Size(8,8)},e(go.Shape,"LineH",{stroke:"#d0ccc7",strokeWidth:0.5}),e(go.Shape,"LineV",{stroke:"#d0ccc7",strokeWidth:0.5}));window.PIXELRATIO=G.computePixelRatio();var n="yellow";G.nodeTemplate=e(go.Node,"Spot",U(e,f),e(go.Panel,"Spot",e(go.Panel,"Auto",e(go.Picture,{desiredSize:new go.Size(60,75),margin:new go.Margin(0,0,0,0)},new go.Binding("source","img"))),e(go.TextBlock,{font:"bold 9pt Helvetica, Arial, sans-serif",stroke:"gray",margin:0,maxSize:new go.Size(60,13),wrap:go.TextBlock.WrapFit,alignment:go.Spot.Bottom,isMultiline:true,textValidation:g,overflow:go.TextBlock.OverflowEllipsis,editable:true},new go.Binding("key"),new go.Binding("text").makeTwoWay())),e(go.Shape,"Circle",{alignment:new go.Spot(0,0,32,-20),alignmentFocus:go.Spot.Top,margin:new go.Margin(0,0,0,0),width:15,height:20,fill:null,strokeWidth:0,stroke:"#818181",doubleClick:function(q,r){d(r.key)},},new go.Binding("key"),new go.Binding("fill","status",F),new go.Binding("strokeWidth","status",J)),{toolTip:e(go.Adornment,"Auto",e(go.Shape,{fill:"lightyellow"}),e(go.Panel,"Vertical",e(go.TextBlock,{margin:new go.Margin(8,6,3,6)},new go.Binding("text").makeTwoWay())))},O("L",new go.Spot(0,0,-1,13),true,true,e),O("R",new go.Spot(0,0,27,13),true,true,e));G.nodeTemplate.selectionAdornmentTemplate=e(go.Adornment,"Spot",e(go.Panel,"Auto",e(go.Shape,{stroke:null,strokeWidth:2,fill:null}),e(go.Placeholder)),e(go.Panel,"Vertical",{alignment:new go.Spot(0,0,75,100),alignmentFocus:go.Spot.Bottom},e("Button",{desiredSize:new go.Size(25,25),actionMove:S,_dragData:{addition:"a Node"},click:C,margin:new go.Margin(0,0,50,0),background:"transparent",cursor:"pointer","ButtonBorder.fill":"transparent","ButtonBorder.stroke":null,"_buttonFillOver":"rgba(0,128,255,0.00)","_buttonStrokeOver":null},e(go.Picture,{source:"./libs/dflow/images/adore_copy.png",width:16,height:16}),new go.Binding("source","img"),new go.Binding("textNew","text"),new go.Binding("pid","pid")),e("Button",{click:c,background:"transparent",cursor:"pointer",margin:new go.Margin(0,0,0,0),"ButtonBorder.fill":"transparent","ButtonBorder.stroke":null,"_buttonFillOver":"rgba(0,128,255,0.00)","_buttonStrokeOver":null},e(go.Picture,{source:"./libs/dflow/images/adore_link.png",width:16,height:16}))),e(go.Panel,"Vertical",{alignment:new go.Spot(0,0,-12,100),alignmentFocus:go.Spot.Bottom},e("Button",{click:function(r,q){G.commandHandler.deleteSelection()},background:"transparent",cursor:"pointer",margin:new go.Margin(0,0,50,0),"ButtonBorder.fill":"transparent","ButtonBorder.stroke":null,"_buttonFillOver":"rgba(0,128,255,0.00)","_buttonStrokeOver":null},e(go.Picture,{source:"./libs/dflow/images/adore_delete.png",width:16,height:16})),e("Button",{cursor:"pointer",click:function(r,q){r.diagram.selection.each(function(s){l(s.data)})},"ButtonBorder.fill":"transparent","ButtonBorder.stroke":null,"_buttonFillOver":"rgba(0,128,255,0.00)","_buttonStrokeOver":null},e(go.Picture,{name:"Picture",source:"./libs/dflow/images/adore_alert.png",width:16,height:16}))));G.linkTemplate=e(go.Link,{curve:go.Link.Normal,corner:5,toShortLength:3,relinkableFrom:true,relinkableTo:true,reshapable:true,resegmentable:true,shadowOffset:new go.Point(0,0),shadowBlur:15,shadowColor:"orange",mouseEnter:function(q,r){r.findObject("HIGHLIGHT").stroke="rgba(30,144,255,0.2)"},mouseLeave:function(q,r){r.findObject("HIGHLIGHT").stroke="transparent"}},new go.Binding("points").makeTwoWay(),e(go.Shape,{isPanelMain:true,strokeWidth:6,stroke:"transparent",name:"HIGHLIGHT"}),e(go.Shape,{isPanelMain:true,stroke:"gray",strokeWidth:2}),e(go.Shape,{toArrow:"standard",stroke:"gray",strokeWidth:3,fill:"red"}));G.linkTemplateMap.add("influence",e(go.Link,{curve:go.Link.Bezier,adjusting:go.Link.Stretch,toShortLength:8,reshapable:true,relinkableFrom:true,relinkableTo:true},new go.Binding("fromSpot","fromSpot",function(q){return E(q)}),new go.Binding("toSpot","toSpot",function(q){return E(q)}),new go.Binding("points").makeTwoWay(),e(go.Shape,{stroke:"gray",strokeWidth:1.5}),e(go.Shape,{fill:"gray",stroke:null,toArrow:"Standard",scale:1.5})));G.toolManager.linkingTool.temporaryLink.routing=go.Link.Normal;G.toolManager.relinkingTool.temporaryLink.routing=go.Link.Normal;var j=G.toolManager.draggingTool;j.doDeactivate=function(){if(j.diagram.undoManager.nestedTransactionNames.elt(0)==="button drag"){j.diagram.commitTransaction()}go.DraggingTool.prototype.doDeactivate.call(j)};if(p){I(e,G,p,i,m)}return[{"diagram":G,"overview":k}]};var R=function(e){var d=go.GraphObject.make;G=d(go.Diagram,e,{initialAutoScale:go.Diagram.UniformToFill,initialContentAlignment:go.Spot.Center,scrollMode:go.Diagram.InfiniteScroll,padding:0,allowDrop:true,});G.nodeTemplate=d(go.Node,"Spot",K(d),d(go.Panel,"Spot",d(go.Panel,"Auto",d(go.Picture,{desiredSize:new go.Size(60,75),margin:new go.Margin(0,0,0,0)},new go.Binding("source","img"))),d(go.TextBlock,{font:"bold 9pt Helvetica, Arial, sans-serif",stroke:"gray",margin:0,maxSize:new go.Size(60,13),wrap:go.TextBlock.WrapFit,alignment:go.Spot.Bottom,isMultiline:true,overflow:go.TextBlock.OverflowEllipsis,editable:false},new go.Binding("key"),new go.Binding("text").makeTwoWay())),d(go.Shape,"Circle",{alignment:new go.Spot(0,0,32,-20),alignmentFocus:go.Spot.Top,margin:new go.Margin(0,0,0,0),width:15,height:20,fill:null,strokeWidth:0,stroke:"#818181",doubleClick:function(f,g){}},new go.Binding("key"),new go.Binding("fill","status",F),new go.Binding("strokeWidth","status",J)),{toolTip:d(go.Adornment,"Auto",d(go.Shape,{fill:"lightyellow"}),d(go.Panel,"Vertical",d(go.TextBlock,{margin:new go.Margin(8,6,3,6)},new go.Binding("text").makeTwoWay())))});G.nodeTemplate.selectionAdornmentTemplate=d(go.Adornment,"Spot");G.linkTemplate=d(go.Link,{curve:go.Link.Normal,corner:5,toShortLength:3,relinkableFrom:false,relinkableTo:false,reshapable:false,resegmentable:false,shadowOffset:new go.Point(0,0),shadowBlur:15,shadowColor:"orange",mouseEnter:function(f,g){g.findObject("HIGHLIGHT").stroke="rgba(30,144,255,0.2)"},mouseLeave:function(f,g){g.findObject("HIGHLIGHT").stroke="transparent"}},new go.Binding("points").makeTwoWay(),d(go.Shape,{isPanelMain:true,strokeWidth:6,stroke:"transparent",name:"HIGHLIGHT"}),d(go.Shape,{isPanelMain:true,stroke:"gray",strokeWidth:2}),d(go.Shape,{toArrow:"standard",stroke:"gray",strokeWidth:3,fill:"red"}));return G};function c(f,d){V.mode="link";V.itemType="flow"}function N(f,d){var g=d.findObject("Picture");V.mode="link";V.itemType="influence";G.allowLink=true;G.nodes.each(function(e){e.port.cursor="pointer"})}function D(f,d){console.log("!!!!!!!!!!!!!!!!!!!!")}function P(f){var d=f.subject.findObject("LABEL");if(d!==null){d.visible=(f.subject.fromNode.data.figure==="Diamond")}}function U(e,d){return[new go.Binding("location").makeTwoWay(),{locationSpot:go.Spot.Center,isShadowed:false,shadowColor:"#888",contextMenu:e(go.Adornment),doubleClick:function(f,g){d(f,g)},click:function(f,g){d(f,g)},mouseOver:function(f,g){if(Q.indexOf(g.data.key)==-1&&f.diagram.nodes.count<=Q.length+1){d(f,g);Q.push(g.data.key)}if(Q.length==0&&f.diagram.nodes.count>1){d(f,g);f.diagram.nodes.each(function(h){Q.push(h.data.key)})}},mouseEnter:function(f,g){T(g.part,true)},mouseLeave:function(f,g){T(g.part,false)}}]}function K(d){return[new go.Binding("location").makeTwoWay(),{locationSpot:go.Spot.Center,isShadowed:false,shadowColor:"#fff",}]}function T(e,d){var f=e.diagram;if(!f||f.isReadOnly||!f.allowLink){return}e.ports.each(function(g){g.stroke=(d?"#8B8B83":"transparent")})}function F(d){var e=go.GraphObject.make;if(d==3){return e(go.Brush,"Radial",{0:"#ff0000",1:"#990000"})}if(d==2){return e(go.Brush,"Radial",{0:"#00ff00",1:"#009900"})}if(d==1){return e(go.Brush,"Radial",{0:"#f7f910",1:"#969900"})}if(d==0){return e(go.Brush,"Radial",{0:"#cacaca",1:"#7e7e7e"})}if(d==-1){return"transparent"}return"transparent"}function J(d){var e=go.GraphObject.make;if(d==3){return 1}if(d==2){return 1}if(d==1){return 1}if(d==0){return 1}if(d==-1){return 0}return 0}function O(e,d,h,f,g){return g(go.Shape,"Circle",{fill:"transparent",stroke:null,strokeWidth:1.5,toMaxLinks:2,desiredSize:new go.Size(8,8),alignment:d,alignmentFocus:d,portId:e,fromSpot:d,toSpot:d,fromLinkable:h,toLinkable:f,cursor:"pointer"})}function b(f,d){var g=d.part.adornedPart;var h=f.diagram.toolManager.linkingTool;h.startObject=g.port;f.diagram.currentTool=h;h.doActivate()}function S(f,d){var g=f.diagram.toolManager.draggingTool;if(g.isBeyondDragSize()){var i=d._dragData;if(!i){return}i.img=d.source;i.text=B(d.textNew,f.diagram);i.pid=d.pid;f.diagram.startTransaction("button drag");var h=A(i,d.part.adornedPart);h.location=f.diagram.lastInput.documentPoint;g.currentPart=h;f.diagram.currentTool=g;g.doActivate()}}function C(f,d){var i=d._dragData;if(!i){return}i.img=d.source;i.text=B(d.textNew,f.diagram);i.pid=d.pid;f.diagram.startTransaction("Create Node and Link");var h=d.part.adornedPart;var g=A(i,h);g.location=new go.Point(h.location.x+180,h.location.y);f.diagram.commitTransaction("Create Node and Link")}function B(j,l){var g=j;var e=[];l.nodes.each(function(n){e.push({"pid":n.data.pid,"name":n.data.text})});if(e.length==0){return g}if(e.length>0){var i=(function(){var o=[];for(var n=0;n<e.length;n++){var q,p=new Array();if(e[n]==undefined){continue}if(e[n].name&&e[n].name.indexOf("(")==-1){q=e[n].name;p.push(q)}else{q=e[n].name.substring(0,e[n].name.indexOf("("));p.push(e[n].name)}if(q==undefined){return}for(var r=n+1;r<e.length;r++){if(e[r]&&e[r].name&&e[r].name.indexOf(q)!=-1){p.push(e[r].name);delete e[r]}}o[n]=new Array();o[n].push(p)}return o})();var m=false;for(var d=0;d<i.length;d++){var h=i[d];if(h==undefined){continue}if(h[0]&&h[0].indexOf(g)!=-1){m=true;var k=[];if(h[0] instanceof Array){h[0].forEach(function(n){if(n.indexOf("(")!=-1){k.push(parseInt(n.substr(n.indexOf("(")+1,1)))}});if(k.length==0){return h[0][0]+"(1)"}if(k.length>0){var f=Math.max.apply(null,k)+1;return h[0][0]+"("+f+")"}}break}}if(!m){return g}}}function A(j,i){var h=i.diagram;var f=h.model;var d=f.copyNodeData(j);f.addNodeData(d);var g=h.findNodeForData(d);var e=f.copyLinkData({});f.setFromKeyForLinkData(e,f.getKeyForNodeData(i.data));f.setToKeyForLinkData(e,f.getKeyForNodeData(g.data));f.addLinkData(e);h.select(g);return g}function E(d){if(d==="left"){return go.Spot.LeftSide}if(d==="right"){return go.Spot.RightSide}if(d==="top"){return go.Spot.TopSide}if(d==="bottom"){return go.Spot.BottomSide}if(d==="rightsingle"){return go.Spot.Right}}function I(f,e,m,h,g){e.contextMenu=f(go.Adornment);e.addDiagramListener("SelectionDeleting",function(i){i.diagram.selection.each(function(n){g(n.data);if(Q.length>0){Q.splice(Q.indexOf(n.data.key),1)}})});var d=e.toolManager.contextMenuTool;var j;if(document.getElementsByClassName(m)){var l=document.getElementsByClassName(m).length;for(var k=0;k<l;k++){if(document.getElementsByClassName(m)[k].parentNode.parentNode.parentNode.id==h.substring(h.lastIndexOf("_")+1)){j=document.getElementsByClassName(m)[k]}}}else{j=document.getElementById(m)}j.addEventListener("contextmenu",function(i){this.focus();i.preventDefault();return false},false);j.addEventListener("blur",function(i){d.stopTool();if(d.canStart()){e.currentTool=d;d.doMouseUp()}},false);j.tabIndex="1";d.showContextMenu=function(i,s){var t=this.diagram;if(t===null){return}if(i!==this.currentContextMenu){this.hideContextMenu()}var n=t.commandHandler;var r=s!==null;var o=document.getElementsByClassName("cut")[0].style.display=r&&n.canCutSelection()?"block":"none";var u=document.getElementsByClassName("copy")[0].style.display=r&&n.canCopySelection()?"block":"none";var v=document.getElementsByClassName("paste")[0].style.display=n.canPasteSelection()?"block":"none";var p=document.getElementsByClassName("delete")[0].style.display=r&&n.canDeleteSelection()?"block":"none";if(o=="block"||n.canPasteSelection()){j.style.display="block"}var q=t.lastInput.viewPoint;if(document.body.clientWidth<1400){j.style.left=q.x+235+"px"}else{j.style.left=q.x+265+"px"}j.style.top=q.y+40+"px";this.currentContextMenu=i};d.hideContextMenu=function(){if(this.currentContextMenu===null){return}j.style.display="none";this.currentContextMenu=null}}return{dflowInit:Y,monitorFlow:R,platteInit:function(d,e){H=$("#"+d+" ."+e).get(0);H.addEventListener("dragstart",function(f){f.dataTransfer.setData("text","");Z.dragged=f.target;if(typeof(f.target.style)!="undefined"){f.target.style.border="2px solid red"}},false);H.addEventListener("dragend",function(f){if(typeof(f.target.style)!="undefined"){Z.dragged.style.border=""}f.preventDefault()},false);return DFlow.call(Z,Z.myDiagram,Z.dragged)},workFlowInit:function(d){W=document.getElementById(d);W.addEventListener("dragenter",function(e){e.preventDefault()},false);W.addEventListener("dragover",function(e){if(e.target.id===d){return}e.preventDefault()},false);W.addEventListener("dragleave",function(e){if(e.target.id==d){e.target.style.background=""}},false);W.addEventListener("drop",function(i){i.preventDefault();if(this===Z.myDiagram.div){var l=i.target;var k=window.PIXELRATIO;if(!(l instanceof HTMLCanvasElement)){return}var m=l.getBoundingClientRect();var n=m.width;if(n===0){n=0.001}var e=m.height;if(e===0){e=0.001}var j=i.clientX-m.left*((l.width/k)/n);var g=i.clientY-m.top*((l.height/k)/e);var h=G.transformViewToDoc(new go.Point(j,g));var f={pid:function(){for(var o=0;o<Z.dragged.childNodes.length;o++){if(Z.dragged.childNodes[o].nodeName=="IMG"){return Z.dragged.childNodes[o].getAttribute("data-pid")}}},img:function(){if(Z.dragged.parentNode.className=="scenario-component"){for(var o=0;o<Z.dragged.childNodes.length;o++){if(Z.dragged.childNodes[o].nodeName=="IMG"){return Z.dragged.childNodes[o].src}}}else{for(var o=0;o<Z.dragged.childNodes.length;o++){if(Z.dragged.childNodes[o].nodeName=="IMG"){return settings.globalVariableUrl()+"/service/v1/resources/components/"+$(Z.dragged.childNodes[o]).data("pid")+"/icon?param=xl"}}}},text:function(w){var r=Z.dragged.textContent.replace(/(^\s*)|(\s*$)/g,"");var p=[];w.nodes.each(function(s){p.push({"pid":s.data.pid,"name":s.data.text})});if(p.length==0){return r}if(p.length>0){var u=(function(){var y=[];for(var s=0;s<p.length;s++){var Aa,z=new Array();if(p[s]==undefined){continue}if(p[s].name&&p[s].name.indexOf("(")==-1){Aa=p[s].name;z.push(Aa)}else{Aa=p[s].name.substring(0,p[s].name.indexOf("("));z.push(p[s].name)}if(Aa==undefined){return}for(var Ab=s+1;Ab<p.length;Ab++){if(p[Ab]&&p[Ab].name&&p[Ab].name.indexOf(Aa)==0){z.push(p[Ab].name);delete p[Ab]}}y[s]=new Array();y[s].push(z)}return y})();var x=false;for(var o=0;o<u.length;o++){var t=u[o];if(t==undefined){continue}if(t[0]&&t[0].indexOf(r)!=-1){x=true;var v=[];if(t[0] instanceof Array){t[0].forEach(function(s){if(s.indexOf("(")!=-1){v.push(parseInt(s.substr(s.indexOf("(")+1,1)))}});if(v.length==0){return t[0][0]+"(1)"}if(v.length>0){var q=Math.max.apply(null,v)+1;return t[0][0]+"("+q+")"}}break}}if(!x){return r}}}};if(Z.dragged.childNodes.length==0){alert("dragged failed,try again!");return}G.startTransaction("new node");G.model.addNodeData({location:h,pid:f.pid(),text:f.text(G),img:f.img()});G.commitTransaction("new node")}},false);return DFlow.call(Z,Z.myDiagram,Z.dragged)},modified:function(d){G.addDiagramListener("Modified",function(g){var f=document.getElementById(d);if(f){f.disabled=!G.isModified}var h=document.title.indexOf("*");if(G.isModified){if(h<0){document.title+="*"}}else{if(h>=0){document.title=document.title.substr(0,h)}}})},cxcommand:function(e){var d=Z.myDiagram;if(!(d.currentTool instanceof go.ContextMenuTool)){return}switch(e){case"剪切":d.commandHandler.cutSelection();break;case"Cut":d.commandHandler.cutSelection();break;case"复制":d.commandHandler.copySelection();break;case"Copy":d.commandHandler.copySelection();break;case"粘贴":d.commandHandler.pasteSelection(d.lastInput.documentPoint);break;case"Paste":d.commandHandler.pasteSelection(d.lastInput.documentPoint);break;case"删除":d.commandHandler.deleteSelection();break;case"Delete":d.commandHandler.deleteSelection();break;case"Color":var f=document.elementFromPoint(event.clientX,event.clientY).parentElement.style.background}d.currentTool.stopTool()},save:function(){var d=Z.myDiagram;return d.model.toJson()}}};